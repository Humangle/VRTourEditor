<!DOCTYPE html>
<html>
	<head>
		<script  type="importmap">
			{
				"imports": {
					"three": "https://threejs.org/build/three.module.js",
					"three/addons/" : "https://threejs.org/examples/jsm/"
				}
			}
		</script>
		<script type="module">
			import * as THREE from 'three';
			import {OrbitControls} from 'three/addons/controls/OrbitControls.js';
			import {VRButton} from 'three/addons/webxr/VRButton.js';
			
			let ready = false; //state of the software
			
			let main = () => {
				//set up the canvas for THREE.js
				const canvas = document.getElementById("c");
				const renderer = new THREE.WebGLRenderer({antialias: true, canvas});
				renderer.setPixelRatio(window.devicePixelRatio);
				renderer.setSize(window.innerWidth, window.innerHeight);
				renderer.xr.enabled = true;
				renderer.xr.setReferenceSpaceType('local');
				renderer.xr.setFoveation(1.0);
				document.body.appendChild(VRButton.createButton(renderer));
				
				//set the camera up
				const fov = 45;
				const aspect = window.innerWidth/window.innerHeight;
				const near = 0.1;
				const far = 100;
				const camera = new THREE.PerspectiveCamera(fov, aspect, near, far);
				camera.position.y = 1.6;
				
				//orbital camera controls
				const controls = new OrbitControls(camera, renderer.domElement);
				controls.enableDamping = true;
				controls.minDistance = 1.1;
				controls.maxDistance = 2;
				controls.target.set(0, 1.6, -2);
				controls.update();
				
				//here we go!
				const scene = new THREE.Scene();
				
				//loading textures
				const loadingElem = document.querySelector('#loading');
				const progressBarElem = loadingElem.querySelector('.progressbar');
				const loadManager = new THREE.LoadingManager();
				const loader = new THREE.TextureLoader(loadManager);
				
				const radius = 1;
				const widthSegments = 32;
				const heightSegments = 24;
				const sphereGeometry = new THREE.SphereGeometry(radius, widthSegments, heightSegments);
				
				const EarthDayTexture = loader.load('https://raw.githubusercontent.com/LearningMike/360images/main/2k_earth_daymap.jpg');
				const EarthNightTexture = loader.load('https://raw.githubusercontent.com/LearningMike/360images/main/2k_earth_nightmap.jpg');
				const EarthNormalTexture = loader.load('https://raw.githubusercontent.com/LearningMike/360images/main/2k_earth_normal_map.tif');
				const EarthSpecularTexture = loader.load('https://raw.githubusercontent.com/LearningMike/360images/main/2k_earth_specular_map.tif');
				const sphereMaterialEarth = new THREE.MeshPhongMaterial({
					color: 0xFFFFFF,
					map: EarthDayTexture,
					emissive: 0xFFFFFF,
					emissiveMap: EarthNightTexture,
					specularMap: EarthSpecularTexture,
					toneMapped: false
				});
					
				let sphereMesh;
				 
				loadManager.onLoad = () => {
					loadingElem.style.display = 'none';
					sphereMesh = new THREE.Mesh(sphereGeometry, sphereMaterialEarth);
					sphereMesh.position.set(0, 1.6, -2);
					scene.add(sphereMesh);
					ready = true;
				};
				
				loadManager.onProgress = (urlOfLastItemLoaded, itemsLoaded, itemsTotal) => {
					const progress = itemsLoaded / itemsTotal;
					progressBarElem.style.transform = `scaleX(${progress})`;
				};
				
				const color = 0xFFFFFF;
				const intensity = 3;
				const light = new THREE.DirectionalLight(color, intensity);
				light.position.set(0, 1.6, 4);
				scene.add(light);
				
				let render = (time) => {
					time *= 0.001; // convert time to seconds
					
					if (ready){
						sphereMesh.rotation.y = time/2;
					}
					
					if (time > 5){
						//sphereMaterialEarth.emissiveIntensity = 1;
					}
					
					renderer.render(scene, camera);
					
				}
				renderer.setAnimationLoop(render);
			}
			main();
		</script>
		<link rel="stylesheet" href="main.css" />
	</head>
	<body>
		<div id="loading">
			<div class="progress"><div class="progressbar"></div></div>
		</div>
		<canvas id="c">
		</canvas>
	</body>
</html>